name: Bump Version Reaction

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+.post[0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+[a-b][0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+rc[0-9]+"

jobs:
  bump-react:
    runs-on: ubuntu-20.04
    outputs:
      job_id: ${{ steps.get-job-id.outputs.job_id }}
    steps:
    - uses: actions/checkout@v2
    - name: Debug
      run: |
        echo "ref: $GITHUB_REF_NAME"
        NAME=$(git for-each-ref $GITHUB_REF_NAME --shell --format='%(authorname)')
        SHA=$(shasum -a 256 LICENSE | awk '{print $1;}')

        echo "Product: Test Python Project"
        echo "Version: $GITHUB_REF_NAME"
        echo "Releaser: $NAME"
        echo "Filename: LICENSE"
        echo "SHASUM: $SHA"

    - name: Get Job ID from GH API
      id: get-job-id
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        jobs=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id}}/attempts/${{ github.run_attempt }}/jobs)
        job_id=$(echo $jobs | jq -r '.jobs[] | select(.runner_name=="${{ runner.name }}") | .id')
        echo "job_id=$job_id" >> $GITHUB_OUTPUT
        echo "hello there $job_id"

  upload-logs:
    runs-on: ubuntu-20.04
    needs: [bump-react]
    steps:
    - uses: actions/checkout@v2
    - name: get logs
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        job_id="${{ needs.bump-react.outputs.job_id }}"
        gh run view --log --job=${job_id}
